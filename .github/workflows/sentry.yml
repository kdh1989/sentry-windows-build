name: Build sentry-native Windows (Debug + Release + crashpad + curl)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022

    steps:
    - uses: actions/checkout@v4

    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: Install CMake
      uses: lukka/get-cmake@latest

    - name: Clone vcpkg
      run: |
        git clone https://github.com/microsoft/vcpkg.git
        cd vcpkg
        bootstrap-vcpkg.bat

    - name: Install curl (vcpkg)
      run: |
        cd vcpkg
        vcpkg install curl:x64-windows

    - name: Clone sentry-native
      run: git clone --recursive https://github.com/getsentry/sentry-native.git

    - name: Configure
      shell: powershell
      run: |
        mkdir build
        cd build
        cmake ../sentry-native `
          -G "Visual Studio 17 2022" `
          -A x64 `
          -DCMAKE_CXX_STANDARD=17 `
          -DSENTRY_BACKEND=crashpad `
          -DSENTRY_TRANSPORT=curl `
          -DSENTRY_BUILD_SHARED_LIBS=ON `
          -DSENTRY_BUILD_TESTS=OFF `
          -DSENTRY_BUILD_EXAMPLES=OFF `
          -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}\vcpkg\scripts\buildsystems\vcpkg.cmake

    - name: Build Debug
      run: cmake --build build --config Debug --parallel

    - name: Build Release
      run: cmake --build build --config Release --parallel

    - name: Collect crashpad_handler (safe)
      shell: powershell
      run: |
        Write-Host "Searching crashpad_handler.exe ..."

        $files = Get-ChildItem -Path ${{ github.workspace }} -Recurse -Filter crashpad_handler.exe

        if ($files.Count -eq 0) {
          Write-Error "crashpad_handler.exe not found!"
          exit 1
        }

        $files | ForEach-Object {
          Write-Host "Found: $($_.FullName)"
        }

        mkdir artifacts -Force | Out-Null
        mkdir artifacts\Debug -Force | Out-Null
        mkdir artifacts\Release -Force | Out-Null

        foreach ($f in $files) {
          if ($f.FullName -match "Debug") {
            Copy-Item $f.FullName artifacts\Debug\ -Force
          }
          if ($f.FullName -match "Release") {
            Copy-Item $f.FullName artifacts\Release\ -Force
          }
        }

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sentry-native-windows-full
        path: |
          build/Debug/**
          build/Release/**
          artifacts/**
